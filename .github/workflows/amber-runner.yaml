name: amber runner

on:
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Path to the root scenario manifest'
        required: true
        default: 'examples/debate/scenario.json5'
        type: string
  workflow_call:
    inputs:
      scenario:
        description: 'Path to the root scenario manifest'
        required: true
        type: string

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Compile scenario
        run: |
          docker run --rm --user "$(id -u):$(id -g)" \
            -v "${{ github.workspace }}:/work" \
            ghcr.io/rdi-foundation/amber-cli:main \
            compile "/work/${{ inputs.scenario }}" \
              --output /work/scenario-ir.json \
              --compose /work/docker-compose.yml
      - name: Export secrets as env vars
        run: |
          echo '${{ toJson(secrets) }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' >> "$GITHUB_ENV"
      - name: Run scenario
        run: docker compose up -d
      - name: Poll for results
        run: |
          docker compose logs -f &
          if ! yq -e '.x-amber.exports.results' docker-compose.yml > /dev/null 2>&1; then
            echo "Error: scenario must have an export named 'results'" >&2
            exit 1
          fi
          poll_host=$(yq '.x-amber.exports.results.published_host' docker-compose.yml)
          poll_port=$(yq '.x-amber.exports.results.published_port' docker-compose.yml)
          poll_url="http://${poll_host}:${poll_port}"
          echo "Polling ${poll_url}..."
          while true; do
            response=$(curl -sf "${poll_url}") || { sleep 5; continue; }
            status=$(echo "${response}" | jq -r '.status')
            if [ "${status}" != "running" ]; then
              echo "${response}" | jq . > results.json
              echo "Scenario finished with status: ${status}"
              break
            fi
            sleep 5
          done
      - name: Stop scenario
        if: always()
        run: docker compose down
      - name: Add participants to results
        run: |
          participants=$(jq '[.components[] | select(.metadata.agentbeats_id) | {(.moniker | ltrimstr("/")): .metadata.agentbeats_id}] | add // {}' scenario-ir.json)
          jq --argjson participants "$participants" '. + {participants: $participants}' results.json > results-final.json
          mv results-final.json results.json
      - name: Generate provenance file
        run: |
          image_digests=$(jq -r '.components[] | select(.program) | "\(.moniker)=\(.program.image)"' scenario-ir.json | while IFS='=' read -r name image; do
            digest=$(docker image inspect "$image" --format '{{index .RepoDigests 0}}')
            printf '%s\t%s\n' "$name" "$digest"
          done | jq -Rn '[inputs | split("\t") | {(.[0]): .[1]}] | add // {}')

          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          manifest_digests=$(jq '[.components[] | {(.moniker): .digest}] | add // {}' scenario-ir.json)

          jq -n \
            --argjson image_digests "$image_digests" \
            --argjson manifest_digests "$manifest_digests" \
            --arg timestamp "$timestamp" \
            --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg ref "${{ github.ref }}" \
            --arg sha "${{ github.sha }}" \
            --arg repository_url "${{ github.server_url }}/${{ github.repository }}" \
            --arg workflow_ref "${{ github.workflow_ref }}" \
            --arg workflow_sha "${{ github.workflow_sha }}" \
            '{
              image_digests: $image_digests,
              manifest_digests: $manifest_digests,
              timestamp: $timestamp,
              github_actions: {
                run_url: $run_url,
                ref: $ref,
                sha: $sha,
                repository_url: $repository_url,
                workflow_ref: $workflow_ref,
                workflow_sha: $workflow_sha
              }
            }' > provenance.json
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scenario-results
          path: |
            results.json
            provenance.json
