name: amber runner

on:
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Path to the root scenario manifest'
        required: true
        default: 'scenario.json5'
        type: string
  workflow_call:
    inputs:
      scenario:
        description: 'Path to the root scenario manifest'
        required: true
        type: string

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Compile scenario
        run: |
          scenario="${{ inputs.scenario }}"
          if [[ "${scenario}" =~ ^https?:// ]]; then
            curl -fsSL "${scenario}" -o scenario-input.json5
            scenario_path="/work/scenario-input.json5"
          else
            scenario_path="/work/${scenario}"
          fi
          docker run --rm --user "$(id -u):$(id -g)" \
            -v "${{ github.workspace }}:/work" \
            ghcr.io/rdi-foundation/amber-cli:main \
            compile "${scenario_path}" \
              --output /work/scenario-ir.json \
              --compose /work/docker-compose.yml
      - name: Export secrets as env vars
        run: |
          echo '${{ toJson(secrets) }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' >> "$GITHUB_ENV"
      - name: Run scenario
        run: docker compose up -d
      - name: Poll for results
        run: |
          docker compose logs -f &
          poll_host=$(yq '.x-amber.exports | to_entries | .[0].value.published_host' docker-compose.yml)
          poll_port=$(yq '.x-amber.exports | to_entries | .[0].value.published_port' docker-compose.yml)
          poll_url="http://${poll_host}:${poll_port}/result"
          echo "Polling ${poll_url}..."
          while true; do
            if response=$(curl -sf "${poll_url}"); then
              status=$(echo "${response}" | jq -r '.status')
              if [ "${status}" != "running" ]; then
                echo "${response}" | jq . > results.json
                echo "Scenario finished with status: ${status}"
                break
              fi
            fi
            sleep 5
          done
      - name: Stop scenario
        if: always()
        run: docker compose down
      - name: Append participants to results
        run: |
          jq '[.components[] | select(.metadata.agentbeats_id) | {(.moniker | ltrimstr("/")): .metadata.agentbeats_id}] | add // {}' \
            scenario-ir.json > participants.json
          jq -s '.[0] + {participants: .[1]}' results.json participants.json > result-final.json
          mv result-final.json results.json
      - name: Generate provenance file
        run: |
          image_digests="{}"
          for row in $(jq -r '.components[] | select(.program) | "\(.moniker)=\(.program.image)"' scenario-ir.json); do
            name="${row%%=*}"
            image="${row#*=}"
            digest=$(docker image inspect "$image" --format '{{index .RepoDigests 0}}')
            image_digests=$(echo "$image_digests" | jq --arg k "$name" --arg v "$digest" '. + {($k): $v}')
          done

          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          manifest_digests=$(jq '[.components[] | {(.moniker): .digest}] | add // {}' scenario-ir.json)

          jq -n \
            --argjson image_digests "$image_digests" \
            --argjson manifest_digests "$manifest_digests" \
            --arg timestamp "$timestamp" \
            --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg ref "${{ github.ref }}" \
            --arg sha "${{ github.sha }}" \
            --arg repository_url "${{ github.server_url }}/${{ github.repository }}" \
            --arg workflow_ref "${{ github.workflow_ref }}" \
            --arg workflow_sha "${{ github.workflow_sha }}" \
            '{
              image_digests: $image_digests,
              manifest_digests: $manifest_digests,
              timestamp: $timestamp,
              github_actions: {
                run_url: $run_url,
                ref: $ref,
                sha: $sha,
                repository_url: $repository_url,
                workflow_ref: $workflow_ref,
                workflow_sha: $workflow_sha
              }
            }' > provenance.json
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scenario-results
          path: |
            results.json
            provenance.json
